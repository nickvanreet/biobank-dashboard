cat(sprintf("    Raw data: %d rows √ó %d cols\n", nrow(raw), ncol(raw)))
mat <- apply(raw, 2, as.character)
hdr <- guess_header_row(mat)
if (is.na(hdr)) {
cat("    ‚úó guess_header_row() returned NA\n")
cat("    Returning empty tibble\n")
return(tibble::tibble())
}
cat(sprintf("    ‚úì Header found at row %d\n", hdr))
headers <- as.character(unlist(raw[hdr, ]))
headers <- make.names(trimws(headers), unique = TRUE)
cat(sprintf("    Headers: %s\n", paste(headers[1:min(6, length(headers))], collapse = ", ")))
dat <- raw[(hdr + 1):nrow(raw), , drop = FALSE]
names(dat) <- headers
dat <- tibble::as_tibble(dat)
dat <- dat[, colSums(!is.na(dat)) > 0, drop = FALSE]
cat(sprintf("    ‚úì Returning %d rows √ó %d cols\n", nrow(dat), ncol(dat)))
if (nrow(dat) == 0) {
cat("    ‚ö†Ô∏è  No data rows after filtering\n")
return(tibble::tibble())
}
dat
}
find_column <- function(df, patterns) {
for (pattern in patterns) {
m <- grep(pattern, names(df), ignore.case = TRUE, value = TRUE)
if (length(m) > 0) return(m[1])
}
NULL
}
pick_cq_col <- function(df) {
find_column(df, c("^Cq$","^Ct$","^Cp$",
"Cq\\s*Mean","Ct\\s*Mean","Cp\\s*Mean",
"Cq\\s*Avg","Ct\\s*Avg","Cp\\s*Avg",
"Cq.*Value","Ct.*Value","Cp.*Value",
"Quant.*Cq","Cross.*Point"))
}
pick_name_col <- function(df) {
if ("Name" %in% names(df)) return("Name")
find_column(df, c("^Name$","Sample.*Name","^Sample$","Identifier","ID",
"^Well$","Well.*Position","Position"))
}
# Test both sheets through the full pipeline
target_defs <- list(
"177T"        = "Cycling 177T Result",
"RNAseP_DNA"  = "Cycling RNAseP-DNA Result"
)
for (tgt in names(target_defs)) {
result_sheet <- target_defs[[tgt]]
cat("\n", strrep("-", 80), "\n")
cat(sprintf("PROCESSING: %s\n", tgt))
cat(sprintf("Sheet: '%s'\n", result_sheet))
cat(strrep("-", 80), "\n")
# Step 1: Call read_any_result_table
df <- read_any_result_table(micrun_file, result_sheet)
# Step 2: Check if empty
if (!nrow(df)) {
cat("\n  ‚úó SKIPPED: read_any_result_table returned empty tibble\n")
next
}
cat(sprintf("\n  ‚úì Got data: %d rows √ó %d cols\n", nrow(df), ncol(df)))
# Step 3: Pick Cq column
cq_col <- pick_cq_col(df)
cat(sprintf("  Cq column: %s\n", if(is.null(cq_col)) "‚úó NOT FOUND" else paste0("‚úì ", cq_col)))
# Step 4: Pick Name column
nm_col <- pick_name_col(df)
cat(sprintf("  Name column: %s\n", if(is.null(nm_col)) "‚úó NOT FOUND" else paste0("‚úì ", nm_col)))
# Step 5: Check if both found
if (is.null(cq_col) || is.null(nm_col)) {
cat("\n  ‚úó SKIPPED: Missing required columns\n")
cat(sprintf("     Available columns: %s\n", paste(names(df), collapse = ", ")))
next
}
# Step 6: Extract data
cat("\n  ‚úì SUCCESS: Would extract Cq data from this sheet\n")
cat(sprintf("     Sample data (first 3 rows):\n"))
for (i in 1:min(3, nrow(df))) {
cat(sprintf("       %s: %s\n", df[[nm_col]][i], df[[cq_col]][i]))
}
}
cat("\n", strrep("=", 80), "\n")
cat("CONCLUSION\n")
cat(strrep("=", 80), "\n\n")
cat("If BOTH sheets show '‚úì SUCCESS', then your actual code has a bug elsewhere.\n")
cat("If RNAseP shows '‚úó SKIPPED', we found where it fails!\n\n")
library(readxl)
library(dplyr)
library(tibble)
micrun_file <- "data/mic/2025-05-06 13.29.03 Run.xlsx"
cat("\n", strrep("=", 80), "\n")
cat("SIMULATING ACTUAL PIPELINE EXECUTION\n")
cat(strrep("=", 80), "\n\n")
# Copy of your actual functions
guess_header_row <- function(mat) {
candidates <- which(apply(mat, 1, function(r) {
any(grepl("\\b(Well|Name|Sample|ID|Identifier|Position)\\b", r, ignore.case = TRUE)) &&
any(grepl("\\b(Cq|Ct|Cp|Quant.*Cq|Cross.*Point)\\b", r, ignore.case = TRUE))
}))
if (length(candidates)) candidates[1] else NA_integer_
}
read_any_result_table <- function(path, sheet) {
cat(sprintf("\n  üìñ Calling read_any_result_table('%s')\n", sheet))
raw <- suppressMessages(readxl::read_excel(path, sheet = sheet, col_names = FALSE, .name_repair = "minimal"))
if (nrow(raw) == 0) {
cat("    ‚ö†Ô∏è  Empty sheet, returning empty tibble\n")
return(tibble::tibble())
}
cat(sprintf("    Raw data: %d rows √ó %d cols\n", nrow(raw), ncol(raw)))
mat <- apply(raw, 2, as.character)
hdr <- guess_header_row(mat)
if (is.na(hdr)) {
cat("    ‚úó guess_header_row() returned NA\n")
cat("    Returning empty tibble\n")
return(tibble::tibble())
}
cat(sprintf("    ‚úì Header found at row %d\n", hdr))
headers <- as.character(unlist(raw[hdr, ]))
headers <- make.names(trimws(headers), unique = TRUE)
cat(sprintf("    Headers: %s\n", paste(headers[1:min(6, length(headers))], collapse = ", ")))
dat <- raw[(hdr + 1):nrow(raw), , drop = FALSE]
names(dat) <- headers
dat <- tibble::as_tibble(dat)
dat <- dat[, colSums(!is.na(dat)) > 0, drop = FALSE]
cat(sprintf("    ‚úì Returning %d rows √ó %d cols\n", nrow(dat), ncol(dat)))
if (nrow(dat) == 0) {
cat("    ‚ö†Ô∏è  No data rows after filtering\n")
return(tibble::tibble())
}
dat
}
find_column <- function(df, patterns) {
for (pattern in patterns) {
m <- grep(pattern, names(df), ignore.case = TRUE, value = TRUE)
if (length(m) > 0) return(m[1])
}
NULL
}
pick_cq_col <- function(df) {
find_column(df, c("^Cq$","^Ct$","^Cp$",
"Cq\\s*Mean","Ct\\s*Mean","Cp\\s*Mean",
"Cq\\s*Avg","Ct\\s*Avg","Cp\\s*Avg",
"Cq.*Value","Ct.*Value","Cp.*Value",
"Quant.*Cq","Cross.*Point"))
}
pick_name_col <- function(df) {
if ("Name" %in% names(df)) return("Name")
find_column(df, c("^Name$","Sample.*Name","^Sample$","Identifier","ID",
"^Well$","Well.*Position","Position"))
}
# Test both sheets through the full pipeline
target_defs <- list(
"177T"        = "Cycling 177T Result",
"RNAseP_DNA"  = "Cycling RNAseP-DNA Result"
)
for (tgt in names(target_defs)) {
result_sheet <- target_defs[[tgt]]
cat("\n", strrep("-", 80), "\n")
cat(sprintf("PROCESSING: %s\n", tgt))
cat(sprintf("Sheet: '%s'\n", result_sheet))
cat(strrep("-", 80), "\n")
# Step 1: Call read_any_result_table
df <- read_any_result_table(micrun_file, result_sheet)
# Step 2: Check if empty
if (!nrow(df)) {
cat("\n  ‚úó SKIPPED: read_any_result_table returned empty tibble\n")
next
}
cat(sprintf("\n  ‚úì Got data: %d rows √ó %d cols\n", nrow(df), ncol(df)))
# Step 3: Pick Cq column
cq_col <- pick_cq_col(df)
cat(sprintf("  Cq column: %s\n", if(is.null(cq_col)) "‚úó NOT FOUND" else paste0("‚úì ", cq_col)))
# Step 4: Pick Name column
nm_col <- pick_name_col(df)
cat(sprintf("  Name column: %s\n", if(is.null(nm_col)) "‚úó NOT FOUND" else paste0("‚úì ", nm_col)))
# Step 5: Check if both found
if (is.null(cq_col) || is.null(nm_col)) {
cat("\n  ‚úó SKIPPED: Missing required columns\n")
cat(sprintf("     Available columns: %s\n", paste(names(df), collapse = ", ")))
next
}
# Step 6: Extract data
cat("\n  ‚úì SUCCESS: Would extract Cq data from this sheet\n")
cat(sprintf("     Sample data (first 3 rows):\n"))
for (i in 1:min(3, nrow(df))) {
cat(sprintf("       %s: %s\n", df[[nm_col]][i], df[[cq_col]][i]))
}
}
cat("\n", strrep("=", 80), "\n")
cat("CONCLUSION\n")
cat(strrep("=", 80), "\n\n")
cat("If BOTH sheets show '‚úì SUCCESS', then your actual code has a bug elsewhere.\n")
cat("If RNAseP shows '‚úó SKIPPED', we found where it fails!\n\n")
# app.R - Mbuji-Mayi Biobank Dashboard v3.1
# ============================================================================
# Load global configuration and libraries
source("global.R")
# ============================================================================
# USER INTERFACE
# ============================================================================
ui <- page_navbar(
title = config$app$title,
theme = app_theme,
# Sidebar with data loading and filters
sidebar = mod_data_manager_ui("data_manager"),
# Navigation panels
mod_data_quality_ui("data_quality"),
mod_overview_demographics_ui("overview_demographics"),
mod_transport_ui("transport"),
mod_extractions_ui("extractions"),
mod_mic_qpcr_ui("mic")
)
# ============================================================================
# SERVER LOGIC
# ============================================================================
server <- function(input, output, session) {
# Core data management module - returns reactive data
data <- mod_data_manager_server("data_manager")
# Pass data to data quality module
mod_data_quality_server(
"data_quality",
raw_data = data$raw_data,
clean_data = data$clean_data,
quality_report = data$quality_report
)
# Pass data to overview & demographics module
mod_overview_demographics_server(
"overview_demographics",
filtered_data = data$filtered_data
)
# Pass filtered data to transport module so visuals respect dashboard filters
mod_transport_server(
"transport",
filtered_data = data$filtered_data
)
# Extraction quality module (uses shared data manager reactives)
mod_extractions_server(
"extractions",
filtered_data = data$filtered_extractions,
biobank_data = data$clean_data
)
# MIC qPCR module - FIXED
mod_mic_qpcr_server(
"mic",
biobank_df = data$clean_data,              # ‚Üê Biobank data from data manager
extractions_df = data$filtered_extractions, # ‚Üê Extractions data from data manager
filters = reactive(NULL)                      # ‚Üê Filters from data manager
)
# Session management
session$onSessionEnded(function() {
message("Session ended")
})
}
# ============================================================================
# RUN APPLICATION
# ============================================================================
shinyApp(ui, server)
# app.R - Mbuji-Mayi Biobank Dashboard v3.1
# ============================================================================
# Load global configuration and libraries
source("global.R")
# ============================================================================
# USER INTERFACE
# ============================================================================
ui <- page_navbar(
title = config$app$title,
theme = app_theme,
# Sidebar with data loading and filters
sidebar = mod_data_manager_ui("data_manager"),
# Navigation panels
mod_data_quality_ui("data_quality"),
mod_overview_demographics_ui("overview_demographics"),
mod_transport_ui("transport"),
mod_extractions_ui("extractions"),
mod_mic_qpcr_ui("mic")
)
# ============================================================================
# SERVER LOGIC
# ============================================================================
server <- function(input, output, session) {
# Core data management module - returns reactive data
data <- mod_data_manager_server("data_manager")
# Pass data to data quality module
mod_data_quality_server(
"data_quality",
raw_data = data$raw_data,
clean_data = data$clean_data,
quality_report = data$quality_report
)
# Pass data to overview & demographics module
mod_overview_demographics_server(
"overview_demographics",
filtered_data = data$filtered_data
)
# Pass filtered data to transport module so visuals respect dashboard filters
mod_transport_server(
"transport",
filtered_data = data$filtered_data
)
# Extraction quality module (uses shared data manager reactives)
mod_extractions_server(
"extractions",
filtered_data = data$filtered_extractions,
biobank_data = data$clean_data
)
# MIC qPCR module - FIXED
mod_mic_qpcr_server(
"mic",
biobank_df = data$clean_data,              # ‚Üê Biobank data from data manager
extractions_df = data$filtered_extractions, # ‚Üê Extractions data from data manager
filters = reactive(NULL)                      # ‚Üê Filters from data manager
)
# Session management
session$onSessionEnded(function() {
message("Session ended")
})
}
# ============================================================================
# RUN APPLICATION
# ============================================================================
shinyApp(ui, server)
# app.R - Mbuji-Mayi Biobank Dashboard v3.1
# ============================================================================
# Load global configuration and libraries
source("global.R")
# ============================================================================
# USER INTERFACE
# ============================================================================
ui <- page_navbar(
title = config$app$title,
theme = app_theme,
# Sidebar with data loading and filters
sidebar = mod_data_manager_ui("data_manager"),
# Navigation panels
mod_data_quality_ui("data_quality"),
mod_overview_demographics_ui("overview_demographics"),
mod_transport_ui("transport"),
mod_extractions_ui("extractions"),
mod_mic_qpcr_ui("mic")
)
# ============================================================================
# SERVER LOGIC
# ============================================================================
server <- function(input, output, session) {
# Core data management module - returns reactive data
data <- mod_data_manager_server("data_manager")
# Pass data to data quality module
mod_data_quality_server(
"data_quality",
raw_data = data$raw_data,
clean_data = data$clean_data,
quality_report = data$quality_report
)
# Pass data to overview & demographics module
mod_overview_demographics_server(
"overview_demographics",
filtered_data = data$filtered_data
)
# Pass filtered data to transport module so visuals respect dashboard filters
mod_transport_server(
"transport",
filtered_data = data$filtered_data
)
# Extraction quality module (uses shared data manager reactives)
mod_extractions_server(
"extractions",
filtered_data = data$filtered_extractions,
biobank_data = data$clean_data
)
# MIC qPCR module - FIXED
mod_mic_qpcr_server(
"mic",
biobank_df = data$clean_data,              # ‚Üê Biobank data from data manager
extractions_df = data$filtered_extractions, # ‚Üê Extractions data from data manager
filters = reactive(NULL)                      # ‚Üê Filters from data manager
)
# Session management
session$onSessionEnded(function() {
message("Session ended")
})
}
# ============================================================================
# RUN APPLICATION
# ============================================================================
shinyApp(ui, server)
# app.R - Mbuji-Mayi Biobank Dashboard v3.1
# ============================================================================
# Load global configuration and libraries
source("global.R")
# ============================================================================
# USER INTERFACE
# ============================================================================
ui <- page_navbar(
title = config$app$title,
theme = app_theme,
# Sidebar with data loading and filters
sidebar = mod_data_manager_ui("data_manager"),
# Navigation panels
mod_data_quality_ui("data_quality"),
mod_overview_demographics_ui("overview_demographics"),
mod_transport_ui("transport"),
mod_extractions_ui("extractions"),
mod_mic_qpcr_ui("mic")
)
# ============================================================================
# SERVER LOGIC
# ============================================================================
server <- function(input, output, session) {
# Core data management module - returns reactive data
data <- mod_data_manager_server("data_manager")
# Pass data to data quality module
mod_data_quality_server(
"data_quality",
raw_data = data$raw_data,
clean_data = data$clean_data,
quality_report = data$quality_report
)
# Pass data to overview & demographics module
mod_overview_demographics_server(
"overview_demographics",
filtered_data = data$filtered_data
)
# Pass filtered data to transport module so visuals respect dashboard filters
mod_transport_server(
"transport",
filtered_data = data$filtered_data
)
# Extraction quality module (uses shared data manager reactives)
mod_extractions_server(
"extractions",
filtered_data = data$filtered_extractions,
biobank_data = data$clean_data
)
# MIC qPCR module - FIXED
mod_mic_qpcr_server(
"mic",
biobank_df = data$clean_data,              # ‚Üê Biobank data from data manager
extractions_df = data$filtered_extractions, # ‚Üê Extractions data from data manager
filters = reactive(NULL)                      # ‚Üê Filters from data manager
)
# Session management
session$onSessionEnded(function() {
message("Session ended")
})
}
# ============================================================================
# RUN APPLICATION
# ============================================================================
shinyApp(ui, server)
# app.R - Mbuji-Mayi Biobank Dashboard v3.1
# ============================================================================
# Load global configuration and libraries
source("global.R")
# ============================================================================
# USER INTERFACE
# ============================================================================
ui <- page_navbar(
title = config$app$title,
theme = app_theme,
# Sidebar with data loading and filters
sidebar = mod_data_manager_ui("data_manager"),
# Navigation panels
mod_data_quality_ui("data_quality"),
mod_overview_demographics_ui("overview_demographics"),
mod_transport_ui("transport"),
mod_extractions_ui("extractions"),
mod_mic_qpcr_ui("mic")
)
# ============================================================================
# SERVER LOGIC
# ============================================================================
server <- function(input, output, session) {
# Core data management module - returns reactive data
data <- mod_data_manager_server("data_manager")
# Pass data to data quality module
mod_data_quality_server(
"data_quality",
raw_data = data$raw_data,
clean_data = data$clean_data,
quality_report = data$quality_report
)
# Pass data to overview & demographics module
mod_overview_demographics_server(
"overview_demographics",
filtered_data = data$filtered_data
)
# Pass filtered data to transport module so visuals respect dashboard filters
mod_transport_server(
"transport",
filtered_data = data$filtered_data
)
# Extraction quality module (uses shared data manager reactives)
mod_extractions_server(
"extractions",
filtered_data = data$filtered_extractions,
biobank_data = data$clean_data
)
# MIC qPCR module - FIXED
mod_mic_qpcr_server(
"mic",
biobank_df = data$clean_data,              # ‚Üê Biobank data from data manager
extractions_df = data$filtered_extractions, # ‚Üê Extractions data from data manager
filters = reactive(NULL)                      # ‚Üê Filters from data manager
)
# Session management
session$onSessionEnded(function() {
message("Session ended")
})
}
# ============================================================================
# RUN APPLICATION
# ============================================================================
shinyApp(ui, server)
