# ==============================================================================
# BIOBANK DASHBOARD - TEST THRESHOLDS CONFIGURATION
# ==============================================================================
# This file defines thresholds for classifying test results as:
# Positive / Borderline / Negative / Invalid
#
# Edit these values to adjust classification cutoffs without changing R code.
# ==============================================================================

# ------------------------------------------------------------------------------
# MIC (qPCR) THRESHOLDS
# ------------------------------------------------------------------------------
# Cq (cycle quantification) values for each target marker
# Lower Cq = more target detected = more positive
#
# Classification logic:
# - Cq < positive_threshold -> Positive
# - Cq between positive and borderline -> Borderline (late positive)
# - Cq > borderline_threshold OR undetermined -> Negative

mic:
  targets:
    # 177T: Trypanozoon-specific DNA marker
    177T:
      positive: 35        # Cq < 35 = clear positive
      borderline: 40      # Cq 35-40 = late positive / borderline
      # Cq > 40 or undetermined = Negative

    # 18S2: Trypanozoon RNA marker (18S ribosomal)
    18S2:
      positive: 35
      borderline: 40

    # RNAseP_DNA: Human DNA extraction control
    RNAseP_DNA:
      positive: 32        # Should be detected if DNA extraction worked
      fail: 45            # Above this = DNA extraction failed

    # RNAseP_RNA: Human RNA extraction control
    RNAseP_RNA:
      positive: 30        # Should be detected if RNA preserved
      fail: 45            # Above this = RNA not preserved

  # RNA preservation assessment (delta = RNAseP_RNA Cq - RNAseP_DNA Cq)
  rna_preservation:
    good: 5               # Delta <= 5 = good preservation
    moderate: 8           # Delta 5-8 = moderate loss
    # Delta > 8 = poor preservation

  # Replicate voting rules
  replicates:
    min_for_positive: 2   # Need at least 2 positive replicates for sample positive
    min_for_negative: 2   # Need at least 2 negative replicates for sample negative
    total_expected: 4     # Expected number of replicates per sample

  # MIC confidence scoring based on replicate agreement and Cq values
  confidence:
    high:
      min_agreeing_reps: 3
      max_cq_177T: 32
    medium:
      min_agreeing_reps: 2
      max_cq_177T: 38
    # Below these thresholds = low confidence

# ------------------------------------------------------------------------------
# ELISA THRESHOLDS
# ------------------------------------------------------------------------------
# PP% (Percent Positivity) and DOD (Delta OD) thresholds
# These apply to both ELISA-PE and ELISA-VSG (same thresholds, different formats)

elisa:
  # PP% based classification (primary metric)
  pp_percent:
    positive: 20          # PP% >= 20 = Positive
    borderline_low: 15    # PP% 15-20 = Borderline
    # PP% < 15 = Negative

  # DOD (Delta OD) based classification (alternative metric)
  dod:
    positive: 0.3         # DOD >= 0.3 = Positive
    borderline_low: 0.2   # DOD 0.2-0.3 = Borderline
    # DOD < 0.2 = Negative

  # Sample-level QC thresholds
  qc:
    max_cv_percent: 20    # CV > 20% = flag for review
    max_cv_invalid: 30    # CV > 30% = Invalid

# ------------------------------------------------------------------------------
# iELISA THRESHOLDS
# ------------------------------------------------------------------------------
# % inhibition thresholds for LiTat 1.3 and LiTat 1.5 antigens
# Higher inhibition = more antibodies present = more positive

ielisa:
  # Inhibition percentage thresholds (Formula 1 - official)
  inhibition:
    positive: 30          # >= 30% inhibition = Positive (per spec section 6.3)
    borderline_low: 25    # 25-30% = Borderline zone
    # < 25% = Negative

  # Formula disagreement QC
  formula_disagreement:
    max_diff_percent: 25  # Flag if F1 and F2 differ by > 25%

# ------------------------------------------------------------------------------
# RETEST RESOLUTION RULES
# ------------------------------------------------------------------------------
# These rules apply when a sample has multiple test results

resolution:
  # Strategy for resolving discordant results
  # Options: "conservative", "most_recent", "quality_weighted", "manual"
  default_strategy: "conservative"

  # Conservative strategy: Positive > Borderline > Negative
  # (Any positive result makes the sample positive)

  # Status priority for conservative resolution (higher = takes precedence)
  status_priority:
    Positive: 100
    Borderline: 50
    Negative: 10
    Invalid: 0

# ------------------------------------------------------------------------------
# SUSPECT CLASSIFICATION
# ------------------------------------------------------------------------------
# Rules for classifying a suspect based on combined test results

classification:
  # Molecular positive = MIC positive
  molecular:
    positive_statuses: ["Positive"]
    borderline_statuses: ["Borderline"]

  # Serological positive = ELISA-VSG+ OR iELISA+
  serological:
    # Confidence levels based on which tests are positive
    high_confidence: "ELISA-VSG+ AND iELISA+"
    low_confidence: "ELISA-VSG+ only"
    unusual: "iELISA+ but ELISA-VSG-"
